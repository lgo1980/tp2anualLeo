services:
  miapp:
    build: .
    container_name: miapp-spring
    ports:
      - "8080:8080"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://db:3306/${MYSQL_DATABASE}?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      - SPRING_DATASOURCE_USERNAME=${MYSQL_USER}
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_PASSWORD}
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=com.mysql.cj.jdbc.Driver
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE}
      - URL_FACHADA_FUENTE=${URL_FACHADA_FUENTE}
      # Configuración para usar Datadog Agent vía StatsD
      - USE_DATADOG_AGENT=true
      - DATADOG_AGENT_HOST=dd-agent
    depends_on:
      - db
      - datadog-agent
    restart: unless-stopped

  db:
    image: mysql:8.0
    container_name: miapp-mysql
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    ports:
      - "3307:3306"
    volumes:
      - db_data:/var/lib/mysql

  # Datadog Agent
  datadog-agent:
    image: gcr.io/datadoghq/agent:7
    container_name: dd-agent
    restart: unless-stopped
    environment:
      - DD_API_KEY=${DATADOG_API_KEY:-4584334ea98e75af1c9c5996784918e2}
      - DD_SITE=${DATADOG_SITE:-us5.datadoghq.com}
      - DD_ENV=${DD_ENV:-dev}
      - DD_DOGSTATSD_NON_LOCAL_TRAFFIC=true
      - DD_APM_ENABLED=true
      - DD_LOGS_ENABLED=true
      - DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL=true
      - DD_CONTAINER_EXCLUDE="name:dd-agent"
      - DD_AC_EXCLUDE="name:dd-agent"
      - DD_PROCESS_AGENT_ENABLED=true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    ports:
      - "8125:8125/udp"  # DogStatsD
      - "8126:8126/tcp"  # APM
    networks:
      - default

volumes:
  db_data: